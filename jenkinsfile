node(){
    stage('Import repositories'){
        dir("build_project"){
            checkout([$class: 'GitSCM',
                branches: [[name: '*/dev']],
                doGenerateSubmoduleConfigurations: false,
                extensions: [[$class: 'CleanCheckout']],
                submoduleCfg: [],
                userRemoteConfigs: [[credentialsId: 'my-git-credentials', url: 'https://github.com/sofackj/jenkins-docker-ansible.git']]
            ])
        }
        dir("ansible_project"){
            checkout([$class: 'GitSCM',
                branches: [[name: '*/dev']],
                doGenerateSubmoduleConfigurations: false,
                extensions: [[$class: 'CleanCheckout']],
                submoduleCfg: [],
                userRemoteConfigs: [[credentialsId: 'my-git-credentials', url: 'https://github.com/sofackj/docker-for-projects.git']]
            ])
        }
    }
    stage("Clean workspace besides new directories"){
        clean_useless("*_project")
    }
    stage ('Environment variables') {
        env.ANSIBLE_IMG = docker.build (
            "my-ansible",
            "./build_project/docker_for_jenkins/dockerfiles/ansible_controller/"
            )
        env.ANSIBLE_DIR = "ansible_project/ansible/ansible_volumes/host_interaction"
        env.ANSIBLE_PLAYBOOK = "host-int-playbook.yml"
    }
    stage ('Build and Deployment') {
        ANSIBLE_IMG.inside ('-u root') {
            dir ("${ANSIBLE_DIR}") {
                ansiblePlaybook (
                    playbook: "${ANSIBLE_PLAYBOOK}"
                )  
            }
        }
    }
    stage("Cleanup"){
        cleanWs()
    }
}

def clean_useless(to_keep){
    sh "pwd && find . ! -name $to_keep ! -name '.*' -maxdepth 1 | xargs rm -rf"
}